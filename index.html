<!doctype html>
<html>
<head>
  <!--Firebase -->
  <script src='https://cdn.firebase.com/js/client/2.2.1/firebase.js'></script>
  <!-- JQUERY -->
  <script src='https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js'></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/spin.js/1.2.7/spin.min.js"></script>

  <!-- BOOTSTRAP -->
  <!-- Latest compiled and minified CSS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">

  <!-- Optional theme -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css">

  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">

  <!-- Latest compiled and minified JavaScript -->
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>

  <!-- CSS -->
  <link rel='stylesheet' type='text/css' href='/css/style.css' >
  
  
</head>
<body>
  <div class= "container">
    <div class="row">
      <a href="index.html"><img src="images/abundancelogo.png" alt="Abundance Logo" height="93" width="330" padding="10px"></a>
      <button type="button" class="btn btn-custom"><a href="javascript:logout();">Logout</a></button>
      <button type="button" class="btn btn-custom"><a href="javascript:loginButton();">Login</a></button>

    </div>
    <div class="row main-container">
     <div class="col-sm-2 visit">  

      <ul class="nav nav-pills nav-stacked">
        <li id= "buy" role="buy" class="active"><a href="javascript:buy();">Meats and Produce</a></li>
        <li id= "sell" role="sell" class="inactive"><a href="javascript:sell();">Preserves and Sauces</a></li>
      </ul>
    </div>

    <div class="col-sm-9 chat-main">

     
      
      <div id='messagesDiv' class="messages" style="overflow:scroll"> </div>
     <!--  <div id="spin"></div> -->
     <br>
      <input type='text' id='messageInput' class="inputBox" placeholder='Type Your Message Here'> 
      <input type="file" accept="image/*" capture="camera" id="file-upload" class="inputPic">
  
      <img style="width:200px;"class="pano" id="pano"/>

      <button type="button" class="btn btn-submit" id="submit" ><a href="javascript:submit();">Submit</a></button>

        <div class="col-sm-1">
           </div>
      </div>
    </div>
  </div>
  <div class="row bottom-social">
    <div class="col-sm-3 social">
      <a href="http://twitter.com" target="_Blank"><i class="fa fa-twitter-square fa-3x"></i></a>
      <a href="http://www.yoututbe.com" target="_Blank"><i class="fa fa-youtube-square fa-3x"></i></a>
      <a href="http://www.facebook.com" target="_Blank"><i class="fa fa-facebook-square fa-3x"></i></a>

    </div>
  </div>

  <div class="modal fade" id="auth-modal">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
          <h4 class="modal-title text-center">Login</h4>
        </div>
        <div class="modal-body text-center">
          <div class="row">
            <div class="col-sm-3"></div>
            <div class="col-sm-3">
              <a id="twitter-signin" href="javascript:login('twitter');">
                <i id="twitter-signin-btn" class="fa fa-twitter-square fa-5x"></i>
                <p>Twitter</p>
              </a>

            </div>

            <div class="col-sm-3">
              <a id="facebook-signin" href="javascript:login('facebook');">
                <i id="facebook-signin-btn" class="fa fa-facebook-square  fa-5x"></i>
                <p>Facebook</p></a>

              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
              <button type="button" class="btn btn-primary">Save changes</button>
            </div>
          </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
      </div><!-- /.modal -->

      <script>

      var channel ='buy';
      var fileInput =$('#file-upload');
      var myDataRef = new Firebase('https://abundance.firebaseio.com/');
      var name=""; 
      var authModal= $('#auth-modal').modal({show: false }) ; //we don't want the modal to show immediately

      // Create a callback which logs the current auth state
      function authDataCallback(authData) {
        if (authData) {
          console.log("User " + authData.uid + " is logged in with " + authData.provider);
          var userId = authData.id;
          name = authData[authData.provider].displayName;
        } else {
          console.log("User is logged out");
        }
      }

// Register the callback to be fired every time auth state changes

document.getElementById("file-upload").addEventListener('change', handleFileSelect, false);

function handleFileSelect(shannon) {
  var f = shannon.target.files[0];
  console.log('the photo is :', f);
  
  var reader = new FileReader();
  console.log('the reader is ', reader);

  reader.onload = (function(theFile) {
    console.log("we are in the onload function");
    
    return function(e){
      console.log("we are in return function");
      var filePayload = e.target.result;
      // var f = myDataRef.child('buy').push({image: e.target.result});

      document.getElementById("pano").src = filePayload;

     
    };
  })(f);
  reader.readAsDataURL(f);
}


myDataRef.onAuth(authDataCallback); 

function submit(e){
  if(!name){
      authModal.modal('show');
          } else { // Don't submit anything unlesswe know users name!
            // var name = $('#nameInput').val();
            var image = document.getElementById("pano").src
            console.log('the picture is ', image);
            var text = $('#messageInput').val();
            myDataRef.child('channel/' + channel).push({name: name, text: text, image: image});
            $('#messageInput').val('');
          }
          fileInput.replaceWith( fileInput = fileInput.clone( true ));
  
          
        }
      ;
  console.log('in submit button')



// $('#messageInput').keypress(function (e) {
//   if (e.keyCode == 13) {
    // if(!name){
    //   authModal.modal('show');
    //       } else { // Don't submit anything unlesswe know users name!
    //         // var name = $('#nameInput').val();
    //         var image = document.getElementById("pano").src
    //         console.log('the picture is ', image);
    //         var text = $('#messageInput').val();
    //         myDataRef.child('channel/' + channel).push({name: name, text: text, image: image});
    //         $('#messageInput').val('');
    //       }

          
    //     }
    //   });

myDataRef.child('channel/' + channel).on('child_added', function(snapshot) {
  var message = snapshot.val();
  displayChatMessage(message.name, message.text, message.image);
  console.log("is this running 3 times")
});

function displayChatMessage(name, text, image) {
  $('<div/>').text(text).prepend($('<em/>').text(name+': ')).appendTo($('#messagesDiv'));
  if (image !='' && image != undefined) {
    $('<div/>').prepend("<img class='messagephoto' src='"+ image + "' />").appendTo($('#messagesDiv'));
  }
  $('#messagesDiv')[0].scrollTop = $('#messagesDiv')[0].scrollHeight;
  console.log("is this running 3 times")
};

function loginButton(){
  console.log("loginButton pressed");
  authModal.modal('show');

}
function login(provider){
  console.log(provider);
  authModal.modal('hide');
  myDataRef.authWithOAuthPopup(provider, function(error, authData) {
    if (error) {
      console.log("Login Failed!", error);
    } else {
      console.log("Authenticated successfully with payload:", authData);
    }
  });
}

function logout(){
  console.log("logging Out")
  myDataRef.unauth();
  location.reload();

}

function buy(){
  // location.reload();
  $("#messagesDiv").empty();
  channel='buy';
  console.log('buy button clicked');
  $("#buy").toggleClass("active");
  $("#sell").removeClass("active");

  myDataRef.child('channel').child('buy').on('child_added',function(snapshot){
  var message=snapshot.val()
  console.log("buy message")
  displayChatMessage(message.name, message.text, message.image);
  console.log("is this running 3 times")

}) 
}

function sell(){
  $("#messagesDiv").empty();
  channel='sell'; 
  console.log('sell button clicked'); 
  $("#sell").toggleClass("active");
  $("#buy").removeClass("active");

  myDataRef.child('channel').child('sell').on('child_added',function(snapshot){
  var message=snapshot.val()
  console.log("sell message")
  displayChatMessage(message.name, message.text, message.image);
  console.log("is this running 3 times")
}) 
}


// var str = ('#messageInput');
// var formattedStr = string.replace ((www\.|(http|https|ftp|news|file)+\:\/\/)[&#95;.a-z0-9-]+\.[a-z0-9\/&#95;:@=.+?,##%&~-]*[^.|\'|\# |!|\(|?|,| |>|<|;|\)]), "<a href='$1>"




</script>
</body>
</html>